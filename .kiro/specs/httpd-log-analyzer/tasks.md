# 実装計画

- [x] 1. 基本的なスクリプト構造とログパーサーの実装








  - シェルスクリプトの基本構造を作成し、コマンドライン引数の処理を実装
  - Common Log FormatとCombined Log Formatを解析する関数を作成
  - ログエントリから IP、タイムスタンプ、リクエスト、ステータスコードを抽出する機能を実装
  - _要件: 1.1, 1.2_

- [x] 2. 高頻度アクセス検出機能の実装










  - IPアドレス別のアクセス履歴を追跡するデータ構造を作成
  - 5分間のスライディングウィンドウで100回以上のアクセスを検出する機能を実装
  - タイムスタンプをUnix時間に変換する関数を作成
  - 高頻度アクセスを検出した場合の記録機能を実装
  - _要件: 1.3, 1.4_

- [x] 3. 400系エラー検出機能の基本実装（404エラー検出）





  - 404レスポンスコードを持つログエントリを特定する機能を実装
  - IPアドレス別に404エラーの回数をカウントする機能を作成
  - 10回以上の404エラーを持つIPを疑わしいとマークする機能を実装
  - 404エラーパターンの検出結果を記録する機能を作成
  - _要件: 2.1, 2.2, 2.3, 2.4_


- [x] 4. SQLインジェクション検出機能の実装



  - SQLインジェクション攻撃の一般的なパターンを定義する配列を作成
  - リクエストURLとパラメータからSQLインジェクションパターンを検索する機能を実装
  - URLエンコードされたSQLパターンをデコードして解析する機能を作成
  - SQLインジェクション攻撃の可能性があるIPを記録する機能を実装
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [x] 5. 認証失敗検出機能の実装




  - 401と403レスポンスコードを特定する機能を実装
  - IPアドレス別に認証失敗の回数と時間を追跡する機能を作成
  - 10分間で20回以上の認証失敗を検出する機能を実装
  - ブルートフォース攻撃の可能性があるIPを記録する機能を作成
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.7_






- [x] 6. IP地理位置検索機能の実装
  - 外部APIサービス（ip-api.com、ipinfo.io、ipapi.co）を使用してIP地理位置を取得する機能を実装
  - whoisコマンドを使用したフォールバック機能を作成
  - 5秒のタイムアウト設定でネットワーク遅延を防止する機能を実装
  - ネットワークエラーやタイムアウトを処理する機能を実装
  - 地理位置検索が失敗した場合に「不明」を返す機能を作成
  - IPアドレスのキャッシュ機能を実装して重複検索を回避
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [x] 17. 包括的な国コードマッピング機能の実装


  - ISO 3166-1 alpha-2標準に基づく全世界195カ国の完全な国コードマッピングを実装
  - convert_country_code関数を作成して2文字の国コードを正式な国名に変換
  - 国連加盟国すべて（アジア・太平洋、ヨーロッパ、アフリカ、南北アメリカ、オセアニア）をサポート
  - 主要な地域・領土（香港、台湾、プエルトリコなど）のマッピングを追加
  - 不明な国コードの場合は元のコードを返すフォールバック機能を実装
  - get_country_info関数を更新して新しい国コード変換機能を統合
  - _要件: 5.5, 5.6_

- [x] 7. レポート生成機能の実装
  - 疑わしいIPアドレス、カウント、理由、国名を含むフォーマットされたレポートを生成する機能を実装
  - 結果を発生回数の降順でソートする機能を作成
  - 疑わしい活動が検出されない場合のメッセージ表示機能を実装
  - 解析実行時のタイムスタンプを含むレポート機能を作成
  - _要件: 6.1, 6.2, 6.3, 6.4_



- [x] 8. 使用方法表示機能の実装





  - 引数なしでスクリプトが実行された場合の検出機能を実装
  - 使用方法のヘルプメッセージを表示するshow_usage関数を作成
  - 具体的な実行例と検出される攻撃パターンの説明を含むヘルプテキストを実装
  - 使用方法表示後に適切な終了コード（0）で終了する機能を作成
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [x] 9. エラーハンドリングと入力検証の実装
  - ログファイルの存在確認と読み取り権限チェック機能を実装
  - ログファイル形式の妥当性検証機能を実装（validate_log_format関数）
  - 不正なログ形式のエントリをスキップする機能を作成
  - コマンドライン引数の検証機能を実装（validate_arguments関数）
  - 統一されたエラーメッセージの表示機能を作成（display_error関数）
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [x] 10. URLデコード機能の実装
  - %XX形式のURLエンコードをデコードする機能を実装
  - 不正なエンコードに対する例外処理を作成
  - SQLインジェクション検出でのURLデコード統合
  - _要件: 9.1, 9.2, 9.3, 9.4_

- [x] 11. メイン処理フローの統合
  - 各検出機能を統合するメイン処理ループを実装
  - ログファイルを1行ずつ読み込んで各検出機能を呼び出す処理を作成
  - 疑わしいIPの重複を排除し、結果をマージする機能を実装
  - 最終的なレポート出力を実行する処理を作成

- [x] 12. テスト用のサンプルデータとテストケースの作成
  - 各種攻撃パターンを含むテスト用ログファイルを作成
  - 正常なアクセスと疑わしいアクセスが混在するサンプルデータを作成
  - スクリプトの動作を検証するテストケースを実装
  - パフォーマンステスト用の大容量ログファイルを作成
  - 個別機能テスト用のスクリプトを作成
  - 包括的なテストドキュメントを作成

- [x] 13. ログタイプ自動判定機能の実装





  - ログファイルの形式を自動識別する機能を実装（detect_log_type関数）
  - access_logとerror_logの形式パターンを定義
  - 混在ログファイルの場合の行ごと判定機能を作成
  - ログタイプに応じた適切なパーサーを選択する機能を実装
  - _要件: 10.1_

- [x] 14. error_log解析機能の実装





  - Apache/Nginxのerror_log形式を解析する関数を作成（parse_error_log_entry）
  - error_logからタイムスタンプ、レベル、IPアドレス、メッセージを抽出する機能を実装
  - error_log特有の攻撃パターンを検出する機能を作成（detect_error_log_threats）
  - ModSecurity、File does not exist、Permission deniedなどのパターンを定義
  - _要件: 10.2, 11.1, 11.2, 11.3, 11.4_
-

- [x] 15. 統合レポート機能の実装








  - access_logとerror_logの解析結果を統合する機能を実装
  - 重複するIPアドレスの検出理由をマージする機能を作成
  - 統合された結果を優先度順にソートする機能を実装
  - error_log由来の脅威情報を含むレポート出力機能を作成
  - _要件: 10.4_
-



- [x] 16. パフォーマンス最適化と最終調整









  - 大容量ログファイル処理時のメモリ使用量最適化
  - 処理速度の改善とボトルネック解析
  - エラーハンドリングの強化
  - コードの最終レビューとリファクタリング

- [x] 18. SSL request log解析機能の実装








  - ssl_request_logの形式を識別するパターンをdetect_log_type関数に追加
  - Apache/Nginxのssl_request_log形式を解析するparse_ssl_request_log_entry関数を作成
  - SSL/TLSプロトコル情報と暗号化スイート情報を抽出する機能を実装
  - ssl_request_logからIP、タイムスタンプ、リクエストURL、ステータスコードを取得する機能を作成
  - ssl_request_logの解析結果を既存の脅威検出機能と統合する処理を実装
  - _要件: 12.1, 12.2, 12.3, 12.4_

- [x] 19. ディレクトリトラバーサル攻撃検出機能の実装








  - ディレクトリトラバーサルパターンを定義する配列を作成（../、..\、URLエンコード版など）
  - detect_directory_traversal関数を実装してリクエストURLからトラバーサルパターンを検索
  - URLエンコードされたトラバーサルパターンをデコードして解析する機能を作成
  - 二重エンコードや不正なUTF-8エンコードも検出する機能を実装
  - 同一IPからの複数回トラバーサル試行を追跡する機能を作成
  - 5回以上の試行で高リスクとして分類する機能を実装
  - _要件: 13.1, 13.2, 13.3, 13.4, 13.5_

- [x] 20. 統合テストとパフォーマンス最適化









  - ssl_request_logとディレクトリトラバーサル検出を含む包括的なテストケースを作成
  - 新機能を含む統合レポート生成機能をテスト
  - ssl_request_log処理による性能影響を測定し、10%以下の劣化に最適化
  - 新しい攻撃パターンを含むサンプルログファイルを作成
  - 全機能の動作確認とエラーハンドリングのテスト

- [x] 21. チャンク処理機能の実装











  - 大容量ログファイルを小さなチャンクに分割する機能を実装（process_log_chunks関数）
  - デフォルト1000行単位でのチャンク処理機能を作成
  - 各チャンクの処理結果を統合する機能を実装
  - 処理進捗を表示する機能を作成（show_progress関数）
  - メモリ使用量を制限するためのクリーンアップ機能を実装（cleanup_chunk_data関数）
  - _要件: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 22. 地理位置検索オプションの実装





  - デフォルトで地理位置検索を無効にする制御フラグを設定
  - --enable-geoコマンドライン引数を認識する機能を実装
  - get_country_info_optimized関数を実装して条件分岐を追加
  - 地理位置検索無効時に「N/A」を表示する機能を作成
  - ヘルプメッセージに--enable-geoオプションの説明を追加
  - _要件: 15.1, 15.2, 15.3, 15.4, 15.5_

- [x] 23. 詳細モード機能の実装












  - デフォルトで高速モードを有効にする制御フラグを設定
  - --detailed-modeコマンドライン引数を認識する機能を実装
  - 詳細モード用の包括的な検出関数を作成（detect_sql_injection_detailed等）
  - URLデコード処理を詳細モードでのみ実行する制御機能を実装
  - 高速モード（デフォルト）では基本的な攻撃パターンのみを検出する機能を作成
  - ヘルプメッセージに--detailed-modeオプションの説明を追加
  - _要件: 16.1, 16.2, 16.3, 16.4, 16.5_

- [x] 24. メモリ最適化とパフォーマンス改善











  - 連想配列のサイズ制限機能を実装（MAX_SUSPICIOUS_IPS、MAX_CACHE_SIZE）
  - 処理済みデータの定期的なクリーンアップ機能を強化
  - 大容量ファイル処理時のバッファ管理を最適化
  - メモリリーク防止のためのデータ構造管理を改善
  - 詳細モード時のパフォーマンス測定とボトルネック解析を実行（高速モードは既に最適化済み）

- [x] 25. 統合テストとパフォーマンス検証





  - チャンク処理、地理位置検索無効化、高速モードを含む包括的なテストケースを作成
  - 大容量ログファイル（1GB以上）でのパフォーマンステストを実行
  - メモリ使用量と処理時間の測定を実施
  - 各オプションの組み合わせでの動作確認テストを作成
  - パフォーマンス改善の効果を定量的に測定し、文書化

- [x] 26. 400系エラー検出機能の実装





  - 400-499の範囲のすべてのクライアントエラーを検出する機能を実装（detect_4xx_errors関数）
  - IPアドレス別に400系エラーの回数と時間を追跡するデータ構造を作成
  - 5分間のスライディングウィンドウで50回以上の400系エラーを検出する機能を実装
  - 特定の400系エラーコード（400, 401, 403, 404, 429など）の集中パターンを分析する機能を作成
  - 攻撃タイプを推定する機能を実装（不正リクエスト攻撃、認証失敗、アクセス制御回避試行、リソース探索など）
  - 同一IPから異なる種類の400系エラーが混在する場合の「複合的な400系エラー攻撃」分類機能を実装
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7_
-

- [x] 27. 400系エラー検出機能の統合とテスト




  - 新しい400系エラー検出機能をメイン処理フローに統合
  - 既存の404エラー検出機能との重複を排除し、より包括的な検出に統合
  - 400系エラー検出を含むテスト用ログファイルを作成
  - 各種400系エラーパターンを含むサンプルデータでの動作確認
  - レポート出力に400系エラー検出結果を含める機能を実装
  - パフォーマンスへの影響を測定し、必要に応じて最適化を実施
- [ ] 28. アクセス制御違反の閾値調整



  - error_logの「client denied」パターンの検出閾値を1回から10回に変更
  - IPごとのアクセス制御違反回数を追跡するデータ構造を実装
  - 10回以上のアクセス制御違反が発生した場合のみレポートに表示する機能を作成
  - 既存のrecord_suspicious_ip関数を修正してカウント機能を統合
  - _要件: 11.3_