# 要件定義書

## 概要

この機能は、Apache/NginxのHTTPサーバーログ（access_log、error_log、ssl_request_log）を解析し、疑わしいアクセスパターンを特定・抽出する高性能なC言語実装ツールの作成を含みます。このツールは、ブルートフォース攻撃、高度なSQLインジェクション攻撃、ディレクトリトラバーサル攻撃、NoSQL攻撃、JSON-RPC攻撃、プロキシ悪用、存在しないページへのアクセス、高頻度アクセスパターン、WAFバイパス技術、権限昇格の試行など、様々な種類の悪意のある活動を検出します。複数のログ形式（標準、タイムスタンプファースト、認証付き、JSON-RPC）に対応し、マルチスレッド処理により5-15倍の性能向上を実現します。出力には、送信元IPアドレス、ユーザー名、発生回数、疑わしいとフラグ付けされた理由、地理的位置情報が含まれます。

## 要件

### 要件1

**ユーザーストーリー:** システム管理者として、HTTPサーバーログを解析して疑わしいアクセスパターンを特定したい。これにより、潜在的なセキュリティ脅威を迅速に検出し、適切な対応を取ることができる。

#### 受け入れ基準

1. スクリプトがログファイルパスで実行される時、システムはApache/Nginxの共通ログ形式エントリを解析する
2. ログエントリを解析する時、システムは単一IPアドレスからの短期間大量アクセスパターンを特定する
3. 高頻度アクセスを検出する時、システムは5分間のスライディングウィンドウで100回以上のリクエストを持つIPを疑わしいとフラグ付けする
4. IPアドレスが過度のリクエストを生成する場合、システムはIP、カウント、理由を「高頻度アクセス」として記録する

### 要件2

**ユーザーストーリー:** セキュリティアナリストとして、短時間に大量の400系エラー（400, 401, 403, 404, 405, 406, 408, 409, 410, 413, 414, 415, 429など）を繰り返すIPアドレスを検出したい。これにより、スキャン活動、ブルートフォース攻撃、DoS攻撃、リソース枯渇攻撃、偵察活動などの悪意のある活動を特定することができる。

#### 受け入れ基準

1. HTTPレスポンスコードを解析する時、システムは400-499の範囲のすべてのクライアントエラーを特定する
2. IPアドレスが5分間のスライディングウィンドウで50回以上の400系エラーを生成する時、システムはそれを疑わしいとフラグ付けする
3. 400系エラーパターンが検出される場合、システムは理由を「大量の400系エラー - スキャン/攻撃の可能性」として記録する
4. 400系エラーをカウントする時、システムは送信元IPアドレスと時間窓でグループ化する
5. 特定の400系エラーコード（400, 401, 403, 404, 429）が集中している場合、システムは詳細な攻撃タイプを推定して記録する
6. 同一IPから異なる種類の400系エラーが混在する場合、システムは「複合的な400系エラー攻撃」として分類する
7. 従来の404エラー検出（10回以上）と認証失敗検出（401/403で20回以上）も包括的に処理する

### 要件3

### 要件4

**ユーザーストーリー:** システム管理者として、高度なSQLインジェクション攻撃の試行を検出したい。これにより、潜在的なデータベース侵害の試みを特定し、ブロックすることができる。

#### 受け入れ基準

1. リクエストURLとパラメータを解析する時、システムは包括的なSQLインジェクションパターンを検索する
2. 基本的なSQLインジェクションパターンを検出する時、システムは「union」、「select」、「drop」、「insert」、「update」、「delete」などのキーワードを特定する
3. 高度なSQLインジェクション技術を検出する時、システムは「extractvalue」、「updatexml」、「exp」、「floor(rand)」、「benchmark」、「sleep」、「pg_sleep」、「waitfor delay」などの関数を特定する
4. Boolean-based blind攻撃を検出する時、システムは「and 1=1」、「or 1=1」、「and 1=2」、「or 1=2」パターンを特定する
5. Union-based攻撃を検出する時、システムは「union all select」、「union select null」、「order by」パターンを特定する
6. WAFバイパス技術を検出する時、システムは「/*!select*/」、「uni%6fn」、「sel%65ct」、「char()」、「concat()」パターンを特定する
7. NoSQL攻撃を検出する時、システムは「$ne」、「$gt」、「$regex」、「$where」、「$or[]」、「$and[]」パターンを特定する
8. LDAP攻撃を検出する時、システムは「*)(」、「)(& 」、「|(」パターンを特定する
9. XML攻撃を検出する時、システムは「<!entity」、「<![cdata」パターンを特定する
10. コメントベース回避を検出する時、システムは「--」、「#」、「/**/」、「%2d%2d」、「%2f%2a」パターンを特定する
11. SQLインジェクションパターンが見つかる場合、システムは送信元IPを「SQLインジェクション攻撃の可能性」の理由で疑わしいとフラグ付けする
12. URLエンコードされたSQLパターンが存在する時、システムはそれらをデコードして解析する

### 要件5

**ユーザーストーリー:** セキュリティアナリストとして、疑わしいIPアドレスの地理的情報を見たい。これにより、潜在的な脅威の起源を理解し、情報に基づいたブロック決定を行うことができる。

#### 受け入れ基準

1. 疑わしいIPが特定される時、システムは各IPアドレスの地理的検索を実行する
2. IP地理位置検索を実行する時、システムは信頼できるIP地理位置サービスまたはデータベースを使用する
3. 地理位置検索が成功する場合、システムは各疑わしいIPの国名を表示する
4. 地理位置検索が失敗する時、システムは国として「不明」を表示する
5. 2文字の国コードが取得される時、システムはISO 3166-1 alpha-2標準に基づいて全世界の国コードを正確な国名に変換する
6. 国コード変換を実行する時、システムは195の国連加盟国すべてと主要な地域・領土を含む包括的なマッピングを使用する

### 要件6

**ユーザーストーリー:** システム管理者として、すべての疑わしい活動の明確な要約レポートが欲しい。これにより、セキュリティ脅威を迅速に評価し、対応アクションの優先順位を付けることができる。

#### 受け入れ基準

1. 解析が完了する時、システムはIPアドレス、カウント、理由、国を示すフォーマットされたレポートを生成する
2. 結果を表示する時、システムは疑わしいIPを発生回数の降順でソートする
3. 疑わしい活動が検出されない場合、システムは「疑わしい活動は検出されませんでした」を表示する
4. レポートを生成する時、システムは解析が実行された時のタイムスタンプを含める

### 要件7

**ユーザーストーリー:** システム管理者として、スクリプトを引数なしで実行した場合に使用方法の例が表示されるようにしたい。これにより、正しい使用方法を素早く確認し、適切にツールを実行することができる。

#### 受け入れ基準

1. スクリプトが引数なしで実行される時、システムは使用方法のヘルプメッセージを表示する
2. ヘルプメッセージを表示する時、システムは基本的な使用法の構文を示す
3. 使用例を表示する時、システムは具体的なログファイルパスを使った実行例を提供する
4. ヘルプメッセージが表示される場合、システムは適切な終了コード（0）で終了する

### 要件8

**ユーザーストーリー:** システム管理者として、ログファイルの形式が正しいかどうかを事前に検証したい。これにより、解析処理を開始する前に不正なファイルを検出し、適切なエラーメッセージを表示することができる。

#### 受け入れ基準

1. ログファイルを解析する前に、システムはファイル形式の妥当性を検証する
2. ログファイルの最初の100行をサンプリングする時、システムは有効なログエントリの割合を計算する
3. 有効なログエントリが50%未満の場合、システムは「無効なログファイル形式」エラーを表示する
4. ログファイル形式が無効な場合、システムは解析処理を中止し、適切な終了コードで終了する

### 要件9

**ユーザーストーリー:** システム管理者として、URLエンコードされた攻撃パターンも検出したい。これにより、エンコードを使用して検出を回避しようとする攻撃者を特定することができる。

#### 受け入れ基準

1. SQLインジェクションパターンを検索する時、システムはURLエンコードされた文字列をデコードする
2. URLデコード処理を実行する時、システムは%XX形式のエンコードを適切な文字に変換する
3. デコードされた文字列に攻撃パターンが含まれる場合、システムは元のIPアドレスを疑わしいとマークする
4. URLデコード処理が失敗する時、システムは元の文字列で検索を継続する

### 要件10

**ユーザーストーリー:** システム管理者として、Apache/Nginxのerror_logファイルも解析して、アクセスログでは検出できないセキュリティ脅威を特定したい。これにより、より包括的なセキュリティ監視を実現することができる。

#### 受け入れ基準

1. ログファイルタイプを判定する時、システムはaccess_logとerror_logの形式を自動識別する
2. error_logを解析する時、システムは「ModSecurity」、「File does not exist」、「Permission denied」、「script not found」などのエラーパターンを検出する
3. error_logで疑わしいパターンが検出される場合、システムはIPアドレスを抽出して疑わしいとマークする
4. error_logとaccess_logの両方が提供される時、システムは結果を統合して重複を排除する

### 要件11

**ユーザーストーリー:** セキュリティアナリストとして、error_logから攻撃の試行を検出したい。これにより、Webアプリケーションファイアウォールによってブロックされた攻撃や、存在しないスクリプトへのアクセス試行を特定することができる。

#### 受け入れ基準

1. ModSecurityのログエントリを解析する時、システムは攻撃タイプとIPアドレスを抽出する
2. 「File does not exist」エラーを検出する時、システムは存在しないファイルへのアクセス試行として記録する
3. 「Permission denied」エラーが頻発する場合、システムは権限昇格攻撃の可能性として記録する
4. 「script not found or unable to stat」エラーを検出する時、システムは不正なスクリプト実行試行として記録する

### 要件12

**ユーザーストーリー:** システム管理者として、SSL request logも解析して、HTTPSトラフィックに含まれる攻撃パターンを検出したい。これにより、暗号化された通信を利用した攻撃も監視することができる。

#### 受け入れ基準

1. ログファイルタイプを判定する時、システムはssl_request_log形式を自動識別する
2. ssl_request_logを解析する時、システムはSSL/TLSハンドシェイク情報とリクエストデータを抽出する
3. ssl_request_logからIPアドレス、タイムスタンプ、リクエストURL、ステータスコードを取得する時、システムは適切な形式で構造化データに変換する
4. ssl_request_logとaccess_log、error_logの解析結果を統合する時、システムは重複を排除して一貫性のあるレポートを生成する

### 要件13

**ユーザーストーリー:** セキュリティアナリストとして、ディレクトリトラバーサル攻撃を検出したい。これにより、システムファイルへの不正アクセス試行を特定し、機密情報の漏洩を防ぐことができる。

#### 受け入れ基準

1. リクエストURLを解析する時、システムはディレクトリトラバーサルパターンを検索する
2. ディレクトリトラバーサルパターンを検出する時、システムは「../」、「..\\」、「%2e%2e%2f」、「%2e%2e%5c」、「....//」、「....\\\\」などのパターンを特定する
3. URLエンコードされたディレクトリトラバーサルパターンが存在する時、システムはそれらをデコードして解析する
4. ディレクトリトラバーサル攻撃パターンが見つかる場合、システムは送信元IPを「ディレクトリトラバーサル攻撃の可能性」の理由で疑わしいとフラグ付けする
5. 同一IPから5回以上のディレクトリトラバーサル試行が検出される時、システムはそれを高リスクとして記録する

### 要件14

**ユーザーストーリー:** システム管理者として、大容量ログファイルを効率的に処理したい。これにより、メモリ使用量を抑制し、処理時間を短縮して、リアルタイムに近い脅威検出を実現することができる。

#### 受け入れ基準

1. 大容量ログファイルを処理する時、システムは小さなチャンクに分割して順次処理する
2. ファイルチャンクサイズを指定する時、システムはデフォルトで1000行単位での処理を実行する
3. メモリ使用量を制限する時、システムは処理済みデータを適切に解放し、メモリリークを防止する
4. チャンク処理を実行する時、システムは各チャンクの処理結果を統合して最終レポートを生成する
5. 処理進捗を表示する時、システムは現在処理中のチャンク番号と全体の進捗率を表示する

### 要件15

**ユーザーストーリー:** システム管理者として、デフォルトで高速処理を実現し、必要に応じて地理位置検索を有効化したい。これにより、通常は高速処理でネットワーク遅延を回避し、詳細な分析が必要な場合のみ地理位置情報を取得することができる。

#### 受け入れ基準

1. デフォルトの動作として、システムは地理位置検索を実行しない
2. コマンドライン引数を解析する時、システムは--enable-geoオプションを認識する
3. --enable-geoオプションが指定される場合、システムは地理位置検索を実行する
4. 地理位置検索が無効な場合、システムは国名として「N/A」を表示する
5. --enable-geoオプションの使用方法を表示する時、システムはヘルプメッセージに説明を含める

### 要件16

**ユーザーストーリー:** システム管理者として、デフォルトで高速処理を実現し、必要に応じて詳細な解析を有効化したい。これにより、通常は高速な概要解析で効率的に処理し、詳細な調査が必要な場合のみ包括的な検出を実行することができる。

#### 受け入れ基準

1. デフォルトの動作として、システムは高速モードで動作し、複雑なパターンマッチングを簡略化する
2. コマンドライン引数を解析する時、システムは--detailed-modeオプションを認識する
3. --detailed-modeが指定される場合、システムは包括的なパターンマッチングとURLデコード処理を実行する
4. 高速モード（デフォルト）では、システムは基本的な攻撃パターンのみを検出し、すでに最適化された処理を実行する
5. --detailed-modeの使用方法を表示する時、システムはヘルプメッセージに処理内容の違いを説明する
6. 高速モード実行時は、システムはすでに最適化された状態であり、追加の高速化提案は行わない


### 要件6

**ユーザーストーリー:** システム管理者として、複数のログ形式に対応したログ解析を行いたい。これにより、様々なサーバー設定や環境に対応できる。

#### 受け入れ基準

1. 標準access_logを解析する時、システムは「IP - - [timestamp] "request" status size」形式を処理する
2. タイムスタンプファーストログを解析する時、システムは「[timestamp] IP - - "request" status size」形式を処理する
3. 認証付きログを解析する時、システムは「IP - username [timestamp] "request" status size」形式を処理する
4. 空ユーザー名ログを解析する時、システムは「IP - "" [timestamp] "request" status size」形式を処理する
5. SSL request_logを解析する時、システムは「[timestamp] IP TLSv1.2 ... "request" status」形式を処理する
6. JSON-RPC SSL logを解析する時、システムは「[timestamp] IP TLSv1.2 ... "{\"id\":1,\"method\":\"...\"}" status」形式を処理する
7. error_logを解析する時、システムは「[timestamp] [level] [client IP] message」形式を処理する
8. 空リクエストを解析する時、システムは「IP - - [timestamp] "" status size」形式を処理する
9. 不完全リクエストを解析する時、システムは「IP - - [timestamp] "-" status size」形式を処理する

### 要件7

**ユーザーストーリー:** システム管理者として、拡張されたHTTPメソッドに対応した攻撃検出を行いたい。これにより、現代的なWebアプリケーションの脅威に対応できる。

#### 受け入れ基準

1. 標準HTTPメソッドを処理する時、システムは「GET」、「POST」、「PUT」、「DELETE」、「HEAD」、「OPTIONS」を認識する
2. 拡張HTTPメソッドを処理する時、システムは「PATCH」、「CONNECT」、「TRACE」、「PRI」を認識する
3. CONNECTメソッド悪用を検出する時、システムは不正なプロキシ利用として記録する
4. HTTP/2 PRIメソッドを検出する時、システムは適切に処理し、必要に応じて攻撃として記録する
5. 空リクエストを検出する時、システムは「EMPTY」メソッドとして分類し、攻撃として記録する
6. 不完全リクエストを検出する時、システムは「INCOMPLETE」メソッドとして分類し、攻撃として記録する

### 要件8

**ユーザーストーリー:** システム管理者として、JSON-RPC攻撃を検出したい。これにより、API悪用やメソッド列挙攻撃を特定できる。

#### 受け入れ基準

1. JSON-RPCリクエストを検出する時、システムはJSONペイロードを識別する
2. JSONメソッドを抽出する時、システムは「"method"」フィールドから実際のメソッド名を取得する
3. JSON-RPC攻撃を分類する時、システムは「JSON:methodname」形式で記録する
4. JSON-RPC攻撃を検出する時、システムはエラーステータス（400+）の場合のみ攻撃として記録する
5. JSONペイロードを記録する時、システムは完全なペイロードをURL欄に保存する

### 要件9

**ユーザーストーリー:** システム管理者として、高性能なログ解析を実行したい。これにより、大容量ログファイルを効率的に処理できる。

#### 受け入れ基準

1. 処理性能を向上させる時、システムはシェルスクリプト版と比較して5-15倍の速度向上を実現する
2. マルチスレッド処理を実行する時、システムは4つのワーカースレッドを使用する
3. メモリ効率を最適化する時、システムはチャンク処理（1000行単位）を使用する
4. 大容量ファイルを処理する時、システムはストリーミング処理でメモリ使用量を制限する
5. パターンマッチングを最適化する時、システムは効率的な文字列検索アルゴリズムを使用する

### 要件10

**ユーザーストーリー:** システム管理者として、認証情報を含む攻撃分析を行いたい。これにより、ブルートフォース攻撃やアカウント列挙攻撃を詳細に分析できる。

#### 受け入れ基準

1. 認証ユーザー名を抽出する時、システムはログからユーザー名情報を取得する
2. 空ユーザー名を処理する時、システムは「""」を「-」として正規化する
3. 認証失敗を分析する時、システムはIPアドレスとユーザー名の組み合わせを記録する
4. ブルートフォース攻撃を検出する時、システムは同一IPからの複数ユーザー名での試行を特定する
5. アカウント列挙攻撃を検出する時、システムは一般的なユーザー名での攻撃パターンを特定する